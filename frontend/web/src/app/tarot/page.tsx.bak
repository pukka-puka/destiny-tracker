'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from '@/contexts/AuthContext';
import { destinyService } from '@/lib/services/destiny.service';
import { majorArcana, calculateParametersFromCards } from '@/data/tarot-cards';
import { Sparkles, RefreshCw, ArrowRight, Heart, Briefcase, DollarSign, Star } from 'lucide-react';
import Image from 'next/image';

export default function TarotPage() {
  const router = useRouter();
  const { user } = useAuth();
  const [step, setStep] = useState<'intro' | 'shuffle' | 'select' | 'reading' | 'result'>('intro');
  const [selectedCards, setSelectedCards] = useState<any[]>([]);
  const [selectedCategory, setSelectedCategory] = useState<string>('general');
  const [isShuffling, setIsShuffling] = useState(false);
  const [interpretation, setInterpretation] = useState<string>('');
  const [saving, setSaving] = useState(false);
  const [loading, setLoading] = useState(false);

  const categories = [
    { id: 'general', label: 'ç·åˆé‹', icon: Star, color: 'from-purple-500 to-pink-500' },
    { id: 'love', label: 'æ‹æ„›é‹', icon: Heart, color: 'from-pink-500 to-red-500' },
    { id: 'work', label: 'ä»•äº‹é‹', icon: Briefcase, color: 'from-blue-500 to-cyan-500' },
    { id: 'money', label: 'é‡‘é‹', icon: DollarSign, color: 'from-green-500 to-emerald-500' },
  ];

  // ã‚«ãƒ¼ãƒ‰ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  const shuffleCards = () => {
    setIsShuffling(true);
    setTimeout(() => {
      setIsShuffling(false);
      setStep('select');
    }, 2000);
  };

  // ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ
  const selectCard = (index: number) => {
    if (selectedCards.length >= 3) return;
    
    const randomCard = majorArcana[Math.floor(Math.random() * majorArcana.length)];
    const newCard = {
      ...randomCard,
      position: selectedCards.length,
      isReversed: Math.random() > 0.5
    };
    
    const newSelectedCards = [...selectedCards, newCard];
    setSelectedCards(newSelectedCards);
    
    // 3æšé¸æŠå®Œäº†ã—ãŸã‚‰è‡ªå‹•çš„ã«AIè§£é‡ˆã¸
    if (newSelectedCards.length === 3) {
      setTimeout(() => {
        setStep('reading');
        getInterpretation(newSelectedCards);
      }, 500);
    }
  };

  // AIè§£é‡ˆã‚’å–å¾—ï¼ˆå¼·åŒ–ç‰ˆï¼‰
  const getInterpretation = async (cards: any[]) => {
    setLoading(true);
    try {
      // APIã‚­ãƒ¼ãŒã‚ã‚‹å ´åˆã¯Claude APIã‚’ä½¿ç”¨
      if (process.env.NEXT_PUBLIC_USE_AI !== 'false') {
        const response = await fetch('/api/tarot', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            cards,
            category: selectedCategory 
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          setInterpretation(data.interpretation);
        } else {
          // APIã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è©³ç´°ãªãƒ­ãƒ¼ã‚«ãƒ«è§£é‡ˆã‚’ä½¿ç”¨
          setInterpretation(generateDetailedLocalInterpretation(cards));
        }
      } else {
        // ãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
        setInterpretation(generateDetailedLocalInterpretation(cards));
      }
      
      setStep('result');
    } catch (error) {
      console.error('Failed to get interpretation:', error);
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯è©³ç´°ãªãƒ­ãƒ¼ã‚«ãƒ«è§£é‡ˆã‚’ä½¿ç”¨
      setInterpretation(generateDetailedLocalInterpretation(cards));
      setStep('result');
    } finally {
      setLoading(false);
    }
  };

  // è©³ç´°ãªãƒ­ãƒ¼ã‚«ãƒ«è§£é‡ˆç”Ÿæˆï¼ˆ2000æ–‡å­—ä»¥ä¸Šï¼‰
  const generateDetailedLocalInterpretation = (cards: any[]) => {
    const categoryLabel = categories.find(c => c.id === selectedCategory)?.label || 'ç·åˆé‹';
    const past = cards[0];
    const present = cards[1];
    const future = cards[2];
    
    return `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸŒŸ ${categoryLabel}ã®è©³ç´°å ã„çµæœ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã‚ãªãŸãŒé¸ã‚“ã 3æšã®ã‚«ãƒ¼ãƒ‰ãŒã€${categoryLabel}ã«ãŠã‘ã‚‹é‡è¦ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¼ãˆã¦ã„ã¾ã™ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â° éå»ï¼š${past.nameJa}${past.isReversed ? 'ï¼ˆé€†ä½ç½®ï¼‰' : 'ï¼ˆæ­£ä½ç½®ï¼‰'}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ã‚«ãƒ¼ãƒ‰ã®æ„å‘³ã€‘
${past.meaning}

ã€éå»ã®å½±éŸ¿ã€‘
${past.nameJa}ã®ã‚«ãƒ¼ãƒ‰ã¯ã€ã‚ãªãŸã®éå»ã«ãŠã‘ã‚‹${categoryLabel}ã®åŸºç›¤ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
${past.isReversed ? 
  'ã“ã®ã‚«ãƒ¼ãƒ‰ãŒé€†ä½ç½®ã§å‡ºãŸã“ã¨ã¯ã€éå»ã«ä½•ã‚‰ã‹ã®èª²é¡Œã‚„æœªè§£æ±ºã®å•é¡ŒãŒã‚ã£ãŸã“ã¨ã‚’ç¤ºå”†ã—ã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€ãã‚Œã¯æˆé•·ã®ãŸã‚ã®é‡è¦ãªçµŒé¨“ã§ã—ãŸã€‚' : 
  'ã“ã®ã‚«ãƒ¼ãƒ‰ãŒæ­£ä½ç½®ã§å‡ºãŸã“ã¨ã¯ã€éå»ã®çµŒé¨“ãŒä»Šã®ã‚ãªãŸã®å¼·ã¿ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚'}

ã“ã®ã‚«ãƒ¼ãƒ‰ãŒç¤ºã™ã®ã¯ã€${past.meaning.split('ã€')[0]}ã¨ã„ã†çµŒé¨“ã‚’é€šã˜ã¦ã€ã‚ãªãŸãŒå­¦ã‚“ã§ããŸã“ã¨ã§ã™ã€‚
éå»ã®ã“ã®çµŒé¨“ã¯ã€ç¾åœ¨ã®ã‚ãªãŸã®${categoryLabel}ã«æ·±ã„å½±éŸ¿ã‚’ä¸ãˆã¦ãŠã‚Šã€ãã‚Œã¯æ±ºã—ã¦ç„¡é§„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
ã‚€ã—ã‚ã€ã“ã‚Œã‚‰ã®çµŒé¨“ãŒã‚ã£ãŸã‹ã‚‰ã“ãã€ä»Šã®ã‚ãªãŸãŒã‚ã‚‹ã®ã§ã™ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸŒ¸ ç¾åœ¨ï¼š${present.nameJa}${present.isReversed ? 'ï¼ˆé€†ä½ç½®ï¼‰' : 'ï¼ˆæ­£ä½ç½®ï¼‰'}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ã‚«ãƒ¼ãƒ‰ã®æ„å‘³ã€‘
${present.meaning}

ã€ç¾åœ¨ã®çŠ¶æ³ã€‘
${present.nameJa}ã¯ã€ã‚ãªãŸã®${categoryLabel}ã®ç¾åœ¨åœ°ã‚’æ˜ç¢ºã«ç¤ºã—ã¦ã„ã¾ã™ã€‚
${present.isReversed ? 
  'é€†ä½ç½®ã§ã‚ã‚‹ã“ã¨ã‹ã‚‰ã€ç¾åœ¨ä½•ã‚‰ã‹ã®èª¿æ•´ã‚„è¦‹ç›´ã—ãŒå¿…è¦ãªæ™‚æœŸã«ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã‚Œã¯æ±ºã—ã¦ãƒã‚¬ãƒ†ã‚£ãƒ–ãªæ„å‘³ã§ã¯ãªãã€ã‚€ã—ã‚æˆé•·ã®ãƒãƒ£ãƒ³ã‚¹ã§ã™ã€‚' : 
  'æ­£ä½ç½®ã§ã‚ã‚‹ã“ã¨ã‹ã‚‰ã€ç¾åœ¨ã®ã‚ãªãŸã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒæ­£ã—ã„æ–¹å‘ã«å‘ã‹ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚'}

ç‰¹ã«æ³¨ç›®ã™ã¹ãã¯ã€${present.meaning.split('ã€')[1]}ã¨ã„ã†ãƒ†ãƒ¼ãƒã§ã™ã€‚
ä»Šã“ã®ç¬é–“ã€ã‚ãªãŸã¯${categoryLabel}ã«ãŠã„ã¦é‡è¦ãªè»¢æ›æœŸã«ã„ã¾ã™ã€‚
${selectedCategory === 'love' ? 'æ„›ã¨äººé–“é–¢ä¿‚' : 
  selectedCategory === 'work' ? 'ä»•äº‹ã¨ã‚­ãƒ£ãƒªã‚¢' : 
  selectedCategory === 'money' ? 'çµŒæ¸ˆã¨è±Šã‹ã•' : 
  'äººç”Ÿå…¨ä½“'}ã®é¢ã§ã€æ–°ãŸãªå¯èƒ½æ€§ãŒé–‹ã‹ã‚Œã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚

ç¾åœ¨ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’æœ€å¤§é™ã«æ´»ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€${present.meaning.split('ã€')[2]}ã‚’æ„è­˜ã™ã‚‹ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”® æœªæ¥ï¼š${future.nameJa}${future.isReversed ? 'ï¼ˆé€†ä½ç½®ï¼‰' : 'ï¼ˆæ­£ä½ç½®ï¼‰'}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ã‚«ãƒ¼ãƒ‰ã®æ„å‘³ã€‘
${future.meaning}

ã€æœªæ¥ã®å¯èƒ½æ€§ã€‘
${future.nameJa}ãŒæœªæ¥ã®ä½ç½®ã«å‡ºãŸã“ã¨ã¯ã€éå¸¸ã«èˆˆå‘³æ·±ã„å±•é–‹ã‚’ç¤ºå”†ã—ã¦ã„ã¾ã™ã€‚
${future.isReversed ? 
  'é€†ä½ç½®ã¯ã€äºˆæƒ³å¤–ã®å±•é–‹ã‚„é•ã£ãŸå½¢ã§ã®æˆå°±ã‚’æ„å‘³ã—ã¾ã™ã€‚æŸ”è»Ÿãªå§¿å‹¢ã§è‡¨ã‚€ã“ã¨ãŒæˆåŠŸã®éµã¨ãªã‚‹ã§ã—ã‚‡ã†ã€‚' : 
  'æ­£ä½ç½®ã¯ã€ã‚ãªãŸã®åŠªåŠ›ãŒå®Ÿã‚’çµã³ã€æœ›ã‚€æ–¹å‘ã¸ã¨é€²ã‚“ã§ã„ãã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚'}

ã“ã®ã‚«ãƒ¼ãƒ‰ãŒç¤ºã™${future.meaning.split('ã€')[0]}ã¨ã„ã†ãƒ†ãƒ¼ãƒã¯ã€ã‚ãªãŸã®${categoryLabel}ã«ãŠã‘ã‚‹åˆ°é”ç‚¹ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚
è¿‘ã„å°†æ¥ã€${selectedCategory === 'love' ? 'ç´ æ™´ã‚‰ã—ã„å‡ºä¼šã„ã‚„é–¢ä¿‚ã®æ·±ã¾ã‚Š' : 
  selectedCategory === 'work' ? 'ä»•äº‹ã§ã®å¤§ããªæˆæœã‚„æ–°ãŸãªãƒãƒ£ãƒ³ã‚¹' : 
  selectedCategory === 'money' ? 'çµŒæ¸ˆçš„ãªå®‰å®šã‚„äºˆæœŸã›ã¬åå…¥' : 
  'äººç”Ÿã«ãŠã‘ã‚‹é‡è¦ãªé”æˆ'}ãŒæœŸå¾…ã§ãã¾ã™ã€‚

ãŸã ã—ã€ã“ã®æœªæ¥ã¯ç¢ºå®šçš„ãªã‚‚ã®ã§ã¯ãªãã€ã‚ãªãŸã®é¸æŠã¨è¡Œå‹•ã«ã‚ˆã£ã¦å½¢ä½œã‚‰ã‚Œã¦ã„ãã¾ã™ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’« 3æšã®ã‚«ãƒ¼ãƒ‰ãŒç´¡ãã‚¹ãƒˆãƒ¼ãƒªãƒ¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

éå»ã®${past.nameJa}ã€ç¾åœ¨ã®${present.nameJa}ã€ãã—ã¦æœªæ¥ã®${future.nameJa}ã€‚
ã“ã®3æšã®ã‚«ãƒ¼ãƒ‰ã®çµ„ã¿åˆã‚ã›ã¯ã€ã‚ãªãŸã®${categoryLabel}ã«ãŠã‘ã‚‹æˆé•·ã®ç‰©èªã‚’æã„ã¦ã„ã¾ã™ã€‚

éå»ã®${past.meaning.split('ã€')[0]}ã‹ã‚‰å§‹ã¾ã‚Šã€
ç¾åœ¨ã®${present.meaning.split('ã€')[0]}ã‚’çµŒã¦ã€
æœªæ¥ã®${future.meaning.split('ã€')[0]}ã¸ã¨å‘ã‹ã†æµã‚Œã¯ã€
ã¾ã•ã«äººç”Ÿã®è‡ªç„¶ãªé€²åŒ–ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚

ç‰¹ã«é‡è¦ãªã®ã¯ã€ã“ã‚Œã‚‰3æšã®ã‚«ãƒ¼ãƒ‰ãŒç¤ºã™ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®å¤‰åŒ–ã§ã™ã€‚
ã‚ãªãŸã¯ç¢ºå®Ÿã«å‰é€²ã—ã¦ãŠã‚Šã€${categoryLabel}ã«ãŠã„ã¦æ–°ãŸãªã‚¹ãƒ†ãƒ¼ã‚¸ã¸ã¨ç§»è¡Œã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¥å¸¸ç”Ÿæ´»ã«æ´»ã‹ã™ãŸã‚ã«ã€ä»¥ä¸‹ã®ã“ã¨ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ï¼š

1. **ä»Šé€±ä¸­ã«å–ã‚‹ã¹ãè¡Œå‹•**
   ${selectedCategory === 'love' ? 'å¤§åˆ‡ãªäººã¨ã®æ™‚é–“ã‚’æ„è­˜çš„ã«ä½œã‚Šã€æ„Ÿè¬ã®æ°—æŒã¡ã‚’è¨€è‘‰ã«ã—ã¦ä¼ãˆã¾ã—ã‚‡ã†ã€‚' : 
     selectedCategory === 'work' ? 'å…ˆå»¶ã°ã—ã«ã—ã¦ã„ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚„èª²é¡Œã«ç€æ‰‹ã—ã€å°ã•ãªä¸€æ­©ã§ã‚‚å‰é€²ã•ã›ã¾ã—ã‚‡ã†ã€‚' : 
     selectedCategory === 'money' ? 'åæ”¯ã‚’è¦‹ç›´ã—ã€å°†æ¥ã®ãŸã‚ã®è²¯è“„è¨ˆç”»ã‚’ç«‹ã¦ã¾ã—ã‚‡ã†ã€‚' : 
     'è‡ªåˆ†ã®æœ¬å½“ã®é¡˜ã„ã‚’æ˜ç¢ºã«ã—ã€ãã‚Œã«å‘ã‘ãŸå…·ä½“çš„ãªè¨ˆç”»ã‚’ç«‹ã¦ã¾ã—ã‚‡ã†ã€‚'}

2. **æ„è­˜ã™ã¹ããƒã‚¤ãƒ³ãƒˆ**
   ç¾åœ¨ã®ã‚«ãƒ¼ãƒ‰${present.nameJa}ãŒç¤ºã™ã‚ˆã†ã«ã€${present.meaning.split('ã€')[1]}ã‚’å¤§åˆ‡ã«ã™ã‚‹ã“ã¨ã§ã™ã€‚
   ã“ã‚Œã¯ä»Šã®ã‚ãªãŸã«æœ€ã‚‚å¿…è¦ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã§ã™ã€‚

3. **é¿ã‘ã‚‹ã¹ãã“ã¨**
   ${past.isReversed || present.isReversed || future.isReversed ? 
     'éåº¦ãªæœŸå¾…ã‚„ç„¦ã‚Šã¯é¿ã‘ã€è‡ªç„¶ãªæµã‚Œã«èº«ã‚’ä»»ã›ã‚‹ã“ã¨ã‚‚å¤§åˆ‡ã§ã™ã€‚' : 
     'ç¾çŠ¶ã«æº€è¶³ã—ã™ããšã€å¸¸ã«æˆé•·ã¨é€²åŒ–ã‚’æ±‚ã‚ã‚‹å§¿å‹¢ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ã€‚'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ€ é–‹é‹ãƒã‚¤ãƒ³ãƒˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼**: ${['ç´«', 'é‡‘', 'é’', 'ç·‘', 'èµ¤', 'ç™½'][Math.floor(Math.random() * 6)]}
ã“ã®è‰²ã‚’èº«ã«ã¤ã‘ãŸã‚Šã€æ„è­˜çš„ã«å–ã‚Šå…¥ã‚Œã‚‹ã“ã¨ã§ã€é‹æ°—ã®æµã‚ŒãŒè‰¯ããªã‚Šã¾ã™ã€‚

**ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ **: ${['ã‚¯ãƒªã‚¹ã‚¿ãƒ«', 'é¦™ã‚Šï¼ˆãŠé¦™ã‚„ã‚¢ãƒ­ãƒï¼‰', 'æ¤ç‰©', 'æ‰‹å¸³', 'éŸ³æ¥½', 'ã‚­ãƒ£ãƒ³ãƒ‰ãƒ«'][Math.floor(Math.random() * 6)]}
ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚«ãƒ¼ãƒ‰ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨ã‚ˆã‚Šæ·±ãã¤ãªãŒã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**ãƒ‘ãƒ¯ãƒ¼ã‚¿ã‚¤ãƒ **: ${['æœã®æ™‚é–“', 'åˆå¾Œ3æ™‚é ƒ', 'å¤•æš®ã‚Œæ™‚', 'æº€æœˆã®å¤œ', 'æ–°æœˆã®æ—¥', 'é€±æœ«ã®åˆå‰ä¸­'][Math.floor(Math.random() * 6)]}
ã“ã®æ™‚é–“å¸¯ã«é‡è¦ãªæ±ºæ–­ã‚„è¡Œå‹•ã‚’èµ·ã“ã™ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚

**é–‹é‹ã®æ–¹ä½**: ${['åŒ—', 'å—', 'æ±', 'è¥¿', 'åŒ—æ±', 'å—è¥¿'][Math.floor(Math.random() * 6)]}
ã“ã®æ–¹è§’ã‚’æ„è­˜ã—ã¦è¡Œå‹•ã™ã‚‹ã¨ã€è‰¯ã„æµã‚Œã‚’å¼•ãå¯„ã›ã‚„ã™ããªã‚Šã¾ã™ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ¨ æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã¯ã€ã‚ãªãŸã®å†…ãªã‚‹çŸ¥æµã¨å®‡å®™ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’ã¤ãªãæ¶ã‘æ©‹ã§ã™ã€‚
ä»Šå›ã®å ã„ã§ç¤ºã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€ã‚ãªãŸã®æ½œåœ¨æ„è­˜ãŒã™ã§ã«çŸ¥ã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã‚‚ã®ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚

${categoryLabel}ã«ãŠã„ã¦ã€ã‚ãªãŸã¯æ­£ã—ã„é“ã‚’æ­©ã‚“ã§ã„ã¾ã™ã€‚
è‡ªä¿¡ã‚’æŒã£ã¦ã€ã‚«ãƒ¼ãƒ‰ãŒç¤ºã™æ–¹å‘ã¸ã¨é€²ã‚“ã§ãã ã•ã„ã€‚
é‹å‘½ã¯ã‚ãªãŸã®å‘³æ–¹ã§ã™ã€‚

ã“ã®å ã„ãŒã€ã‚ãªãŸã®${categoryLabel}ã«ãŠã‘ã‚‹ç´ æ™´ã‚‰ã—ã„æœªæ¥ã¸ã®é“ã—ã‚‹ã¹ã¨ãªã‚Šã¾ã™ã‚ˆã†ã«ã€‚

ğŸŒ™ å ã„å¸«ã‚ˆã‚Šæ„›ã‚’è¾¼ã‚ã¦`;
  };

  // ã‚«ãƒ¼ãƒ‰ç”»åƒåã‚’å–å¾—
  const getCardImageName = (cardName: string) => {
    const imageMap: Record<string, string> = {
      'æ„šè€…': '0-fool',
      'é­”è¡“å¸«': '1-magician',
      'å¥³æ•™çš‡': '2-high-priestess',
      'å¥³å¸': '3-empress',
      'çš‡å¸': '4-emperor',
      'æ•™çš‡': '5-hierophant',
      'æ‹äºº': '6-lovers',
      'æˆ¦è»Š': '7-chariot',
      'åŠ›': '8-strength',
      'éš è€…': '9-hermit',
      'é‹å‘½ã®è¼ª': '10-wheel-of-fortune',
      'æ­£ç¾©': '11-justice',
      'åŠã‚‹ã•ã‚ŒãŸç”·': '12-hanged-man',
      'æ­»ç¥': '13-death',
      'ç¯€åˆ¶': '14-temperance',
      'æ‚ªé­”': '15-devil',
      'å¡”': '16-tower',
      'æ˜Ÿ': '17-star',
      'æœˆ': '18-moon',
      'å¤ªé™½': '19-sun',
      'å¯©åˆ¤': '20-judgement',
      'ä¸–ç•Œ': '21-world'
    };
    return imageMap[cardName];
  };

  // å ã„çµæœã‚’ä¿å­˜ï¼ˆä¿®æ­£ç‰ˆï¼‰
  const saveReading = async () => {
    if (!user || saving) return;
    
    setSaving(true);
    try {
      const parameters = calculateParametersFromCards(selectedCards);
      const overallScore = Math.round(Object.values(parameters).reduce((a: number, b: number) => a + b, 0) / 6);
      
      const reading = {
        userId: user.uid,
        readingType: 'daily-tarot' as const,
        parameters,
        daily: {
          overall: overallScore,
          luckyColor: ['èµ¤', 'é’', 'ç·‘', 'é»„', 'ç´«', 'æ©™'][Math.floor(Math.random() * 6)],
          luckyNumber: Math.floor(Math.random() * 9) + 1,
          advice: 'ä»Šæ—¥ã¯æ–°ã—ã„ã“ã¨ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã™ã‚‹çµ¶å¥½ã®æ—¥ã§ã™ã€‚'
        },
        tarotReading: {
          cards: selectedCards,
          spread: 'past-present-future' as const,
          interpretation,
          shortTermAdvice: 'ç›´æ„Ÿã‚’ä¿¡ã˜ã¦è¡Œå‹•ã™ã‚‹ã“ã¨ãŒæˆåŠŸã¸ã®éµã¨ãªã‚Šã¾ã™ã€‚',
          detailedMeanings: {
            past: `${selectedCards[0].nameJa}ï¼š${selectedCards[0].meaning}`,
            present: `${selectedCards[1].nameJa}ï¼š${selectedCards[1].meaning}`,
            future: `${selectedCards[2].nameJa}ï¼š${selectedCards[2].meaning}`
          }
        }
      };
      
      await destinyService.createReading(reading);
      
      console.log('âœ… å ã„çµæœã‚’ä¿å­˜ã—ã¾ã—ãŸï¼', reading);
      
      router.push('/dashboard');
    } catch (error) {
      console.error('Failed to save reading:', error);
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-purple-900 via-purple-800 to-indigo-900 text-white p-4">
      <div className="max-w-6xl mx-auto">
        
        {/* ã‚¤ãƒ³ãƒˆãƒ­ */}
        {step === 'intro' && (
          <div className="flex flex-col items-center justify-center min-h-[80vh] text-center">
            <Sparkles className="w-16 h-16 mb-6 text-yellow-300 animate-pulse" />
            <h1 className="text-4xl font-bold mb-4">ã‚¿ãƒ­ãƒƒãƒˆå ã„</h1>
            <p className="text-xl mb-8 text-purple-200">
              AIãŒå°ãã€ã‚ãªãŸã®é‹å‘½ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            </p>
            
            {/* ã‚«ãƒ†ã‚´ãƒªé¸æŠ */}
            <div className="mb-8">
              <p className="mb-4 text-purple-300">å ã„ãŸã„å†…å®¹ã‚’é¸ã‚“ã§ãã ã•ã„</p>
              <div className="grid grid-cols-2 gap-4">
                {categories.map((cat) => {
                  const Icon = cat.icon;
                  return (
                    <button
                      key={cat.id}
                      onClick={() => setSelectedCategory(cat.id)}
                      className={`px-6 py-4 rounded-xl font-semibold transition-all transform hover:scale-105 ${
                        selectedCategory === cat.id
                          ? 'bg-gradient-to-r ' + cat.color + ' shadow-lg scale-105'
                          : 'bg-purple-800/50 hover:bg-purple-700/50'
                      }`}
                    >
                      <Icon className="w-6 h-6 mx-auto mb-2" />
                      {cat.label}
                    </button>
                  );
                })}
              </div>
            </div>
            
            <button
              onClick={() => setStep('shuffle')}
              className="px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full text-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition transform hover:scale-105"
            >
              å ã„ã‚’å§‹ã‚ã‚‹
            </button>
          </div>
        )}

        {/* ã‚·ãƒ£ãƒƒãƒ•ãƒ« */}
        {step === 'shuffle' && (
          <div className="flex flex-col items-center justify-center min-h-[80vh]">
            <h2 className="text-3xl font-bold mb-8">ã‚«ãƒ¼ãƒ‰ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ä¸­...</h2>
            <div className="relative w-48 h-72 mb-8">
              {[...Array(5)].map((_, i) => (
                <div
                  key={i}
                  className={`absolute inset-0 bg-gradient-to-br from-purple-600 to-pink-600 rounded-lg shadow-2xl transform ${
                    isShuffling ? 'animate-shuffle' : ''
                  }`}
                  style={{
                    transform: `rotate(${i * 5 - 10}deg) translateX(${i * 2}px)`,
                    zIndex: 5 - i
                  }}
                >
                  <div className="w-full h-full rounded-lg border-2 border-purple-300 opacity-50" />
                </div>
              ))}
            </div>
            {!isShuffling && (
              <button
                onClick={shuffleCards}
                className="px-6 py-3 bg-yellow-500 text-purple-900 rounded-full font-semibold hover:bg-yellow-400 transition"
              >
                ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹
              </button>
            )}
          </div>
        )}

        {/* ã‚«ãƒ¼ãƒ‰é¸æŠ */}
        {step === 'select' && (
          <div className="flex flex-col items-center justify-center min-h-[80vh]">
            <h2 className="text-3xl font-bold mb-4">ã‚«ãƒ¼ãƒ‰ã‚’3æšé¸ã‚“ã§ãã ã•ã„</h2>
            <p className="text-purple-200 mb-8">{selectedCards.length}/3 æšé¸æŠæ¸ˆã¿</p>
            
            <div className="grid grid-cols-7 gap-2 mb-8">
              {[...Array(22)].map((_, i) => (
                <button
                  key={i}
                  onClick={() => selectCard(i)}
                  disabled={selectedCards.length >= 3}
                  className="w-16 h-24 bg-gradient-to-br from-purple-600 to-pink-600 rounded-lg shadow-lg hover:shadow-2xl transition-all transform hover:scale-110 hover:-translate-y-2 disabled:opacity-50 disabled:hover:scale-100"
                >
                  <div className="w-full h-full rounded-lg border border-purple-300 opacity-50" />
                </button>
              ))}
            </div>

            {selectedCards.length > 0 && (
              <div className="flex gap-4">
                {['éå»', 'ç¾åœ¨', 'æœªæ¥'].map((label, i) => (
                  <div key={i} className="text-center">
                    <p className="text-sm mb-2">{label}</p>
                    <div className={`w-20 h-32 rounded-lg border-2 ${
                      selectedCards[i] 
                        ? 'bg-gradient-to-br from-yellow-400 to-orange-500 border-yellow-400 shadow-lg' 
                        : 'border-dashed border-purple-400'
                    }`}>
                      {selectedCards[i] && (
                        <div className="w-full h-full flex items-center justify-center">
                          <div className="text-center p-2">
                            <p className="text-xs text-purple-900 font-bold">
                              {selectedCards[i].nameJa}
                            </p>
                            {selectedCards[i].isReversed && (
                              <p className="text-xs text-purple-700 mt-1">é€†ä½ç½®</p>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* AIè§£é‡ˆä¸­ */}
        {step === 'reading' && loading && (
          <div className="flex flex-col items-center justify-center min-h-[80vh]">
            <div className="mb-8">
              <div className="flex gap-8">
                {selectedCards.map((card, i) => {
                  const imageName = getCardImageName(card.nameJa);
                  return (
                    <div key={i} className="text-center">
                      <p className="text-lg mb-2 text-yellow-300">{['éå»', 'ç¾åœ¨', 'æœªæ¥'][i]}</p>
                      <div className="w-32 h-48 rounded-lg shadow-2xl overflow-hidden">
                        {imageName ? (
                          <img
                            src={`/tarot-cards/${imageName}.jpg`}
                            alt={card.nameJa}
                            className="w-full h-full object-cover"
                          />
                        ) : (
                          <div className="w-full h-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center">
                            <p className="text-purple-900 font-bold">{card.nameJa}</p>
                          </div>
                        )}
                      </div>
                      <p className="mt-2 text-sm text-purple-200">
                        {card.isReversed && 'é€†ä½ç½®'}
                      </p>
                    </div>
                  );
                })}
              </div>
            </div>
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-300 mx-auto mb-4"></div>
              <p className="text-xl text-purple-200 animate-pulse">
                AIãŒã‚«ãƒ¼ãƒ‰ã®æ„å‘³ã‚’è§£é‡ˆä¸­...
              </p>
              <p className="text-sm text-purple-300 mt-2">
                è©³ç´°ãªå ã„çµæœã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™
              </p>
            </div>
          </div>
        )}

        {/* çµæœè¡¨ç¤º */}
        {step === 'result' && !loading && (
          <div className="flex flex-col items-center py-12">
            <h2 className="text-3xl font-bold mb-8">
              {categories.find(c => c.id === selectedCategory)?.label}ã®å ã„çµæœ
            </h2>
            
            {/* ã‚«ãƒ¼ãƒ‰è¡¨ç¤º */}
            <div className="flex gap-8 mb-12">
              {selectedCards.map((card, i) => {
                const imageName = getCardImageName(card.nameJa);
                return (
                  <div key={i} className="text-center">
                    <p className="text-lg mb-2 text-yellow-300">{['éå»', 'ç¾åœ¨', 'æœªæ¥'][i]}</p>
                    <div className="w-32 h-48 rounded-lg shadow-2xl overflow-hidden transform hover:scale-110 transition-transform">
                      {imageName ? (
                        <img
                          src={`/tarot-cards/${imageName}.jpg`}
                          alt={card.nameJa}
                          className="w-full h-full object-cover"
                        />
                      ) : (
                        <div className="w-full h-full bg-gradient-to-br from-yellow-400 to-orange-500 p-3">
                          <div className="w-full h-full rounded border-2 border-yellow-600 flex flex-col items-center justify-center">
                            <p className="text-xl font-bold text-purple-900">{card.nameJa}</p>
                            {card.isReversed && <p className="text-xs text-purple-700 mt-1">é€†ä½ç½®</p>}
                          </div>
                        </div>
                      )}
                    </div>
                    <p className="mt-2 text-sm text-purple-200">
                      {card.nameJa}{card.isReversed ? 'ï¼ˆé€†ä½ç½®ï¼‰' : ''}
                    </p>
                  </div>
                );
              })}
            </div>

            {/* AIè§£é‡ˆ */}
            <div className="max-w-4xl w-full bg-purple-800/50 backdrop-blur rounded-xl p-8 mb-8">
              <div className="prose prose-invert max-w-none">
                <div className="whitespace-pre-wrap text-purple-100 leading-relaxed text-lg">
                  {interpretation}
                </div>
              </div>
            </div>

            {/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */}
            <div className="flex gap-4">
              <button
                onClick={() => {
                  setStep('intro');
                  setSelectedCards([]);
                  setInterpretation('');
                }}
                className="px-6 py-3 bg-purple-600 rounded-full font-semibold hover:bg-purple-700 transition flex items-center gap-2"
              >
                <RefreshCw className="w-4 h-4" />
                ã‚‚ã†ä¸€åº¦å ã†
              </button>
              
              <button
                onClick={saveReading}
                disabled={saving}
                className="px-6 py-3 bg-gradient-to-r from-yellow-500 to-orange-500 text-purple-900 rounded-full font-semibold hover:from-yellow-600 hover:to-orange-600 transition flex items-center gap-2 disabled:opacity-50"
              >
                {saving ? 'ä¿å­˜ä¸­...' : 'çµæœã‚’ä¿å­˜'}
                <ArrowRight className="w-4 h-4" />
              </button>
            </div>
          </div>
        )}
      </div>

      <style jsx>{`
        @keyframes shuffle {
          0%, 100% { transform: translateX(0) rotateZ(0deg); }
          25% { transform: translateX(-20px) rotateZ(-5deg); }
          75% { transform: translateX(20px) rotateZ(5deg); }
        }
        .animate-shuffle {
          animation: shuffle 0.5s ease-in-out infinite;
        }
      `}</style>
    </div>
  );
}
